# ============================================================================
# WORKFLOW ANDROID TEST BUILD - OPTIMIZED FOR 2025
# ============================================================================
#
# Implementa as melhores prÃ¡ticas de 2025 do GitHub Actions Marketplace:
# âœ… Gradle Build Scan integration
# âœ… Dependency graph submission (seguranÃ§a)
# âœ… Cache granular multi-layer
# âœ… Concurrency control
# âœ… Timeout protection
# âœ… Enhanced error reporting
# âœ… Incremental builds
# âœ… Cache hit monitoring
#
# ============================================================================

name: Build Android APK - Test (Personal Use)

on:
  workflow_call:
    inputs:
      triggered_by:
        description: 'Evento que triggou o build'
        required: false
        type: string
        default: 'workflow_call'
      commit_sha:
        description: 'SHA do commit'
        required: false
        type: string
      branch_name:
        description: 'Nome do branch'
        required: false
        type: string
      pr_number:
        description: 'NÃºmero do PR (se aplicÃ¡vel)'
        required: false
        type: number
        default: 0
    secrets:
      UNSPLASH_KEY:
        required: false
      UNSPLASH_CLIENT_ID:
        required: false

  workflow_dispatch:
    inputs:
      release_name:
        description: 'Nome customizado para a release (opcional)'
        required: false
        default: ''

# Cancela builds antigos do mesmo branch/PR
concurrency:
  group: android-build-${{ github.ref }}-${{ inputs.commit_sha || github.sha }}
  cancel-in-progress: true

jobs:
  build-android-test:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      UNSPLASH_KEY: ${{ secrets.UNSPLASH_KEY }}
      UNSPLASH_CLIENT_ID: ${{ secrets.UNSPLASH_CLIENT_ID }}
      # OtimizaÃ§Ãµes Gradle para CI (2025 best practices)
      GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true -Dorg.gradle.configureondemand=true
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle

    steps:
      # ===== CHECKOUT E SETUP =====
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.commit_sha || github.sha }}
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js with automatic npm cache
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'

      - name: â˜• Setup Java with automatic Gradle cache
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: 21
          cache: 'gradle'

      # ===== GRADLE SETUP COM MELHORES PRÃTICAS 2025 =====
      - name: ğŸ˜ Setup Gradle with optimized cache & build scan
        uses: gradle/actions/setup-gradle@v5
        with:
          # Cache read-only em PRs para evitar corrupÃ§Ã£o
          cache-read-only: ${{ github.event_name == 'pull_request' }}
          # Cache granular - sÃ³ o que importa
          gradle-home-cache-includes: |
            caches
            notifications
            wrapper
          gradle-home-cache-excludes: |
            caches/build-cache-*
            caches/*/plugin-resolution/
          gradle-home-cache-cleanup: true
          # Build Scan para debug avanÃ§ado (2025 feature)
          build-scan-publish: true
          build-scan-terms-of-service-url: "https://gradle.com/help/legal-terms-of-use"
          build-scan-terms-of-service-agree: "yes"
          # Dependency graph para seguranÃ§a (2025 feature)
          dependency-graph: generate-and-submit

      - name: ğŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          log-accepted-android-sdk-licenses: false

      # ===== CACHE ADICIONAL: Android SDK Components =====
      - name: ğŸ’¾ Cache Android SDK components
        uses: actions/cache@v4
        with:
          path: |
            ~/.android/sdk
            ~/.android/avd
          key: android-sdk-${{ runner.os }}-${{ hashFiles('android/build.gradle', 'android/app/build.gradle') }}
          restore-keys: |
            android-sdk-${{ runner.os }}-

      # ===== CACHE NPM ADICIONAL (alÃ©m do setup-node) =====
      - name: ğŸ“¦ Get npm cache directory
        id: npm-cache-dir
        shell: bash
        run: echo "dir=$(npm config get cache)" >> $GITHUB_OUTPUT

      - name: ğŸ’¾ Cache npm dependencies (granular)
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: ${{ steps.npm-cache-dir.outputs.dir }}
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # ===== CACHE: Frontend Build Output (Incremental Build) =====
      - name: ğŸ’¾ Cache frontend build output
        uses: actions/cache@v4
        id: frontend-cache
        with:
          path: |
            dist/
            .angular/
            .tmp/angular-dist/
          key: frontend-build-${{ runner.os }}-${{ hashFiles('src/**', 'package-lock.json') }}
          restore-keys: |
            frontend-build-${{ runner.os }}-

      # ===== INSTALL DEPENDENCIES =====
      - name: ğŸ“š Install npm packages
        run: npm ci --prefer-offline --no-audit

      # ===== BUILD DEBUG APK COM BUILD SCAN =====
      - name: ğŸ”¨ Build Android Debug APK with Build Scan
        id: build
        continue-on-error: true
        run: npm run dist:android -- --scan
        env:
          NODE_ENV: development

      # ===== ERROR HANDLING: Upload logs em falha =====
      - name: ğŸ“‹ Upload Gradle logs on build failure
        if: steps.build.outcome == 'failure'
        uses: actions/upload-artifact@v5
        with:
          name: gradle-build-logs-failure-${{ github.run_number }}
          path: |
            android/.gradle/
            android/app/build/reports/
            android/build/reports/
          retention-days: 7

      - name: âŒ Fail job if build failed
        if: steps.build.outcome == 'failure'
        run: exit 1

      # ===== VALIDATE BUILD =====
      - name: ğŸ” List and validate generated APK files
        id: apk-info
        run: |
          echo "=== APK Output Directory Structure ==="
          ls -lah android/app/build/outputs/apk/ || true
          echo ""
          echo "=== Finding all APK files ==="
          find android/app/build/outputs/apk -name "*.apk" -exec ls -lh {} \;
          echo ""
          echo "=== APK Details ==="
          APK_PATH=$(find android/app/build/outputs/apk/fdroid/debug -name "*.apk" | head -1)
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
            APK_SIZE_BYTES=$(stat -c%s "$APK_PATH" 2>/dev/null || stat -f%z "$APK_PATH")
            APK_SHA256=$(sha256sum "$APK_PATH" | cut -d' ' -f1)
            APK_NAME=$(basename "$APK_PATH")

            echo "âœ… APK gerado com sucesso!"
            echo "ğŸ“¦ Nome: $APK_NAME"
            echo "ğŸ“ Tamanho: $APK_SIZE ($APK_SIZE_BYTES bytes)"
            echo "ğŸ” SHA256: $APK_SHA256"

            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
            echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
            echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
            echo "apk_sha256=$APK_SHA256" >> $GITHUB_OUTPUT
            echo "build_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ERRO: APK nÃ£o foi gerado!"
            echo "build_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      # ===== CACHE HIT REPORTING (2025 Best Practice) =====
      - name: ğŸ“Š Report cache statistics to job summary
        run: |
          echo "### ğŸ“Š Cache Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Layer | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| npm cache | ${{ steps.npm-cache.outputs.cache-hit == 'true' && 'âœ… HIT' || 'âŒ MISS' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend build | ${{ steps.frontend-cache.outputs.cache-hit == 'true' && 'âœ… HIT' || 'âŒ MISS' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gradle cache | Auto-managed by setup-gradle@v5 |" >> $GITHUB_STEP_SUMMARY
          echo "| Java/Gradle | Auto-managed by setup-java |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“± APK Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Name**: \`${{ steps.apk-info.outputs.apk_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: ${{ steps.apk-info.outputs.apk_size }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA256**: \`${{ steps.apk-info.outputs.apk_sha256 }}\`" >> $GITHUB_STEP_SUMMARY

      # ===== UPLOAD ARTIFACTS =====
      - name: ğŸ“¤ Upload APK as workflow artifact
        uses: actions/upload-artifact@v5
        with:
          name: super-productivity-android-test-${{ github.run_number }}
          path: android/app/build/outputs/apk/fdroid/debug/*.apk
          retention-days: 30
          if-no-files-found: error
          compression-level: 0  # APK jÃ¡ Ã© comprimido

      # ===== CREATE RELEASE (apenas em push/merge, nÃ£o em PR) =====
      - name: ğŸ·ï¸ Generate release name
        if: inputs.triggered_by == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        id: release-name
        run: |
          if [ -n "${{ github.event.inputs.release_name }}" ]; then
            RELEASE_NAME="${{ github.event.inputs.release_name }}-test"
          else
            VERSION=$(cat package.json | grep '"version"' | head -1 | sed 's/.*: "\(.*\)".*/\1/')
            DATE=$(date +%Y%m%d-%H%M)
            RELEASE_NAME="v${VERSION}-test-${DATE}-build${{ github.run_number }}"
          fi
          echo "name=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          echo "Generated release name: ${RELEASE_NAME}"

      - name: ğŸš€ Create or update GitHub Release
        if: inputs.triggered_by == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release-name.outputs.name }}
          name: "ğŸ§ª Test Build - ${{ steps.release-name.outputs.name }}"
          body: |
            ## ğŸ¤– Android APK - Build de Teste (Uso Pessoal)

            **âš ï¸ ATENÃ‡ÃƒO**: Este Ã© um build de **teste/desenvolvimento** para uso pessoal.

            ### ğŸ”´ LimitaÃ§Ãµes deste build:
            - âŒ APK **nÃ£o-assinado** (debug build)
            - âŒ NÃ£o otimizado para produÃ§Ã£o (mais lento e maior)
            - âŒ Usa flavor `fdroid` (sem serviÃ§os Google Play)
            - âœ… Apenas para testes em dispositivos pessoais

            ---

            ### ğŸ“± Como instalar:

            1. **Baixe o APK** abaixo (procure por `app-fdroid-debug.apk`)
            2. No **Android**, vÃ¡ em:
               - ConfiguraÃ§Ãµes â†’ SeguranÃ§a
               - Habilite "**Instalar apps desconhecidos**" ou "**Fontes desconhecidas**"
            3. **Abra o APK** baixado e toque em **Instalar**
            4. Se jÃ¡ tiver uma versÃ£o instalada, vocÃª pode precisar desinstalar primeiro

            ---

            ### ğŸ“Š InformaÃ§Ãµes do Build:

            | Info | Valor |
            |------|-------|
            | **APK** | `${{ steps.apk-info.outputs.apk_name }}` |
            | **Tamanho** | `${{ steps.apk-info.outputs.apk_size }}` |
            | **SHA256** | `${{ steps.apk-info.outputs.apk_sha256 }}` |
            | **Commit** | [`${{ inputs.commit_sha || github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ inputs.commit_sha || github.sha }}) |
            | **Branch** | `${{ inputs.branch_name || github.ref_name }}` |
            | **Build #** | `${{ github.run_number }}` |
            | **Trigger** | `${{ inputs.triggered_by || github.event_name }}` |
            | **Workflow** | [Ver execuÃ§Ã£o](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |

            ---

            ### ğŸ“ Ãšltimo commit:
            ```
            ${{ github.event.head_commit.message }}
            ```

            ---

            ### ğŸ” VerificaÃ§Ã£o de Integridade:

            Para verificar a integridade do APK baixado:
            ```bash
            sha256sum app-fdroid-debug.apk
            # Deve corresponder a: ${{ steps.apk-info.outputs.apk_sha256 }}
            ```

            ---

            ### ğŸ†š DiferenÃ§as vs Build de ProduÃ§Ã£o:

            | Aspecto | ProduÃ§Ã£o | Este Build (Teste) |
            |---------|----------|-------------------|
            | Flavor | `play` | `fdroid` |
            | Build Type | `release` | `debug` |
            | Assinatura | Keystore produÃ§Ã£o | Debug auto-sign |
            | OtimizaÃ§Ã£o | Minificado | NÃ£o otimizado |
            | Google Play Services | âœ… Sim | âŒ NÃ£o |
            | Destino | Google Play Store | Teste pessoal |

            ---

            _Build gerado automaticamente com GitHub Actions - Otimizado com best practices 2025_
          files: android/app/build/outputs/apk/fdroid/debug/*.apk
          draft: false
          prerelease: true
          make_latest: false
          token: ${{ secrets.GITHUB_TOKEN }}
          fail_on_unmatched_files: true

      # ===== COMENTÃRIO NO PR =====
      - name: ğŸ’¬ Comment on PR with APK info
        if: inputs.pr_number != 0
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `## ğŸ¤– Android APK de Teste Gerado!

            âœ… O build do APK de teste foi concluÃ­do com sucesso.

            ### ğŸ“¦ InformaÃ§Ãµes do APK:
            - **Nome**: \`${{ steps.apk-info.outputs.apk_name }}\`
            - **Tamanho**: ${{ steps.apk-info.outputs.apk_size }}
            - **SHA256**: \`${{ steps.apk-info.outputs.apk_sha256 }}\`

            ### ğŸ“¥ Download:
            Os APKs estÃ£o disponÃ­veis nos [artifacts desta execuÃ§Ã£o](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            âš ï¸ **Nota**: O APK serÃ¡ publicado em Releases apenas apÃ³s o merge para \`main\`.

            ---
            Build #${{ github.run_number }} | Commit: \`${context.payload.pull_request.head.sha.substring(0, 7)}\``;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.pr_number }},
              body: comment
            });

      # ===== SUCCESS NOTIFICATION =====
      - name: âœ… Build completed successfully
        run: |
          echo "========================================="
          echo "âœ… APK de teste gerado com sucesso!"
          echo "========================================="
          echo "ğŸ“Š Trigger: ${{ inputs.triggered_by || github.event_name }}"
          echo "ğŸ“¦ Branch: ${{ inputs.branch_name || github.ref_name }}"
          echo "ğŸ”— Commit: ${{ inputs.commit_sha || github.sha }}"
          echo "ğŸ“± APK: ${{ steps.apk-info.outputs.apk_name }}"
          echo "ğŸ“ Tamanho: ${{ steps.apk-info.outputs.apk_size }}"
          echo ""
          if [ "${{ inputs.triggered_by }}" == "push" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ] || [ "${{ github.event_name }}" == "push" ]; then
            echo "ğŸ“¦ Release: ${{ steps.release-name.outputs.name }}"
            echo "ğŸ”— URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.release-name.outputs.name }}"
          else
            echo "ğŸ“¦ APK disponÃ­vel nos artifacts"
            echo "ğŸ”— URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          echo "========================================="
