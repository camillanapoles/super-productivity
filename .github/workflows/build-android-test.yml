# ğŸ§ª Workflow para build Android de TESTE/USO PESSOAL
# Gera APK debug nÃ£o-assinado para instalaÃ§Ã£o em dispositivos pessoais
# O APK Ã© disponibilizado em Releases com sufixo "-test"
#
# Este workflow Ã© independente do build-android.yml de produÃ§Ã£o
# e NÃƒO requer keystore ou upload para Google Play Console

name: Build Android APK - Test (Personal Use)

on:
  push:
    branches: [master, release/*, test/*]
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Nome customizado para a release (opcional)'
        required: false
        default: ''

jobs:
  build-android-test:
    runs-on: ubuntu-latest

    env:
      UNSPLASH_KEY: ${{ secrets.UNSPLASH_KEY }}
      UNSPLASH_CLIENT_ID: ${{ secrets.UNSPLASH_CLIENT_ID }}

    steps:
      # ğŸ“¥ Checkout com histÃ³rico completo para versionamento correto
      - name: ğŸ“¥ Checkout sources
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch all history for proper versioning

      # ğŸ”§ Reconfigure git for npm dependencies from GitHub
      - name: ğŸ”§ Reconfigure git to use HTTP authentication
        run: >
          git config --global url."https://github.com/".insteadOf
          ssh://git@github.com/

      # ğŸŸ¢ Setup Node.js
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20

      # â˜• Setup Java
      - name: â˜• Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: 21

      # ğŸ”§ Setup Gradle com cleanup automÃ¡tico
      - name: ğŸ”§ Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-home-cache-cleanup: true

      # ğŸ¤– Setup Android SDK
      - name: ğŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          log-accepted-android-sdk-licenses: true

      # ğŸ“¦ Cache adicional para npm directory
      - name: ğŸ“¦ Get npm cache directory
        id: npm-cache-dir
        run: |
          echo "dir=$(npm config get cache)" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ Cache npm directory
        uses: actions/cache@v4
        with:
          path: ${{ steps.npm-cache-dir.outputs.dir }}
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # ğŸ“¦ Instalar dependÃªncias (usa cache quando possÃ­vel)
      - name: ğŸ“¦ Install npm packages
        run: npm i

      # ğŸ—ï¸ Build APK debug (sem keystore)
      - name: ğŸ—ï¸ Build Debug APK (unsigned, personal use)
        run: npm run dist:android

      # ğŸ” Debug output - mostrar APKs gerados
      - name: ğŸ” List generated APK files
        run: |
          echo "ğŸ“± Generated APK files:"
          find android/app/build/outputs/apk -name "*.apk" -type f -exec ls -lh {} \;
          echo ""
          echo "ğŸ“‚ APK locations:"
          find android/app/build/outputs/apk -name "*.apk" -type f

      # ğŸ“¤ Upload APKs como artifacts
      - name: ğŸ“¤ Upload APK artifacts
        uses: actions/upload-artifact@v5
        with:
          name: super-productivity-android-test-${{ github.run_number }}
          path: android/app/build/outputs/apk/**/*.apk
          retention-days: 30

      # ğŸ·ï¸ Gerar nome da release com sufixo -test
      - name: ğŸ·ï¸ Generate release name
        id: release_name
        run: |
          # Get version from package.json
          VERSION=$(node -p "require('./package.json').version")

          # Use custom name if provided, otherwise use version-based name
          if [ -n "${{ github.event.inputs.release_name }}" ]; then
            RELEASE_NAME="${{ github.event.inputs.release_name }}"
          else
            RELEASE_NAME="v${VERSION}-test-build-${{ github.run_number }}"
          fi

          echo "release_name=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Release name: ${RELEASE_NAME}"

      # ğŸš€ Criar GitHub Release com APKs
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_name.outputs.release_name }}
          name: ${{ steps.release_name.outputs.release_name }}
          prerelease: true  # Marca como prerelease (nÃ£o Ã© versÃ£o oficial)
          make_latest: false  # NÃ£o marcar como latest release
          fail_on_unmatched_files: true
          files: |
            android/app/build/outputs/apk/**/*.apk
          body: |
            # ğŸ§ª Build de Teste - Super Productivity v${{ steps.release_name.outputs.version }}

            âš ï¸ **ATENÃ‡ÃƒO**: Este Ã© um build de teste/uso pessoal, nÃ£o uma versÃ£o oficial.

            ## ğŸ“± InstalaÃ§Ã£o

            1. Baixe o arquivo APK abaixo
            2. No seu dispositivo Android, habilite "Fontes desconhecidas" nas configuraÃ§Ãµes
            3. Instale o APK baixado

            ## â„¹ï¸ InformaÃ§Ãµes do Build

            - **VersÃ£o**: ${{ steps.release_name.outputs.version }}
            - **Build Number**: ${{ github.run_number }}
            - **Branch**: ${{ github.ref_name }}
            - **Commit**: ${{ github.sha }}
            - **Ãšltima mensagem**: ${{ github.event.head_commit.message || 'Manual workflow dispatch (sem mensagem de commit disponÃ­vel)' }}

            ## ğŸ“¦ APKs DisponÃ­veis

            Os APKs estÃ£o listados abaixo nos assets desta release.

            ---

            *Build gerado automaticamente pelo workflow build-android-test.yml*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # âœ… Mensagem de sucesso
      - name: âœ… Build completed successfully
        run: |
          echo "ğŸ‰ Build de teste concluÃ­do com sucesso!"
          echo "ğŸ“¦ Release criada: ${{ steps.release_name.outputs.release_name }}"
          echo "ğŸ”— APKs disponÃ­veis em: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_name.outputs.release_name }}"
